<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
        <meta http-equiv="Pragma" content="no-cache" />
        <meta http-equiv="Expires" content="0" />
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
        <meta name="viewport" content="initial-scale=1, maximum-scale=1">
        <link rel="preconnect" href="https://fonts.gstatic.com">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i,800,800i&display=swap" rel="stylesheet">
        <link href="/style.css" rel="stylesheet">
        <link rel="stylesheet" href="/style.css">
        <script src="/script.js" defer></script>
        <script src="/shadows.js" defer></script>
        <meta author="text" content="Pau Maestre i Claudia Moyano (2n DAW)">
        <link rel="shortcut icon" href="" />
        <title>Gestor de bases de dades web</title>
    </head>
    <body>
        <header>
            <h1 class="titolprincipal">Gestor de base de dades web</h1>            
        </header>

        <user-login></user-login>
        
        <select name="editar" id="editar" class="editar" onchange="gestorBBDD(this)">
            <option value="">Selecciona Opción</option>
            <option value="filas">Gestor Filas</option>
            <option value="tablas">Gestor Tablas</option>
        </select>
        <h2 id="mensajeInformativo"></h2>
        <div class="container" id="gestionFilas">
            <!-- CREAR FILA -->
            <div id="crearFilaDiv">
            <h3>Crear fila</h3>
            
                <form id="userForm">
                    <label for="submitName">Name:</label>
                    <input type="text" id="submitName" name="submitName" required><br>

                    <label for="submitMail">Mail:</label>
                    <input type="text" id="submitMail" name="submitMail" required><br>
                
                    <label for="submitPassword">Password:</label>
                    <input type="password" id="submitPassword" name="submitPassword" required><br>
                    <button type="button" onclick="submitRow()">Submit</button>
                </form>
            </div>
                  
            <div id="esborrarFila">
                <h3>Esborrar fila</h3>
                <form id="deleteForm">
                    <label for="deleteID">ID:</label>
                    <input type="text" id="deleteID" name="deleteID" required><br>
                    <p>Segur/a?</p>
                    <button type="button" onclick="deleteRow()">Delete</button>
                </form>
            </div>

            <div id="editarFila">
                <h3>Editar fila</h3>
                <form id="editForm">
                    <label for="editID">ID:</label>
                    <input type="text" id="editID" name="editID" required><br>
                    
                    <label for="editName">Name:</label>
                    <input type="text" id="editName" name="editName" required><br>
                
                    <label for="editMail">Mail:</label>
                    <input type="text" id="editMail" name="editMail" required><br>
                
                    <label for="editPwdHash">Password Hash:</label> 
                    <input type="password" id="editPwdHash" name="editPwdHash" required><br>
                
                    <button type="button" onclick="clean()">Clean Fields</button>
                  </form>
            </div>
                
        </div>
        <div class="container" id="gestionTablas">
            <div id="crearTable">
                <h3>Crear Tabla</h3>
                <p id="conteo">Número de campos: 0</p>
                <br>
                <form id="createTable">
                    <label for="createName">Name</label>
                    <input type="text" id="createName" name="createName" required>
                    <button onclick="createTable()">Crear Tabla</button>
                    <button onclick="agregarCampo()">Añadir campo</button>
                </form>
            </div>

            <div>
                <h3>Borrar Tabla</h3>
                <form id="deleteTable">
                    <label for="tabla_borrar">Que tabla quieres borrar?</label>
                    <input type="text" name="tabla_borrar" id="tabla_borrar">
                    <button onclick="eliminarTabla()">Eliminar Tabla</button>
                </form>
            </div>

            <!-- Editar -->
            <div>
                <h3>Editar taula</h3>
                <form id="editTable">
                    <label for="editTableName">Nom de la taula a editar:</label>
                    <input type="text" id="editTableName" name="editTableName" required>
                    <button type="button" onclick="editTable()">Editar</button>
                </form>
            </div>
        </div>

            <script>
            
            function submitRow() {
                var submitName = document.getElementById("submitName").value;
                var submitMail = document.getElementById("submitMail").value;
                var submitPassword = document.getElementById("submitPassword").value;

                fetch('/submitForm', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({name_sub: submitName, mail_sub: submitMail, pwdHash_sub: submitPassword}),
                    })
                    .then(response => response.json())
                    .then(data => {

                        document.getElementById('mensajeInformativo').innerText = data.message
                        document.getElementById("userForm").reset();
                    })
                .catch(error => console.error('Error:', error));
            }

            // BORRAR FILA
            function deleteRow() {
                var deleteID = document.getElementById("deleteID").value;

                fetch('/deleteUser', {
                    method: 'POST',
                    headers: {
                    'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ ID: deleteID }),
                })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('mensajeInformativo').innerText = data.message
                    document.getElementById("deleteForm").reset();
                })
                .catch(error => console.error('Error:', error));
            }

            function editRow() {
                var editID = document.getElementById("editID").value;
                var editName = document.getElementById("editName").value;
                var editMail = document.getElementById("editMail").value;
                var editPwdHash = document.getElementById("editPwdHash").value;

                fetch('/editUser', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({id: editID,name: editName, mail: editMail, pwdHash: editPwdHash}),
                    })
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('mensajeInformativo').innerText = data.message
                        
                    })
                .catch(error => console.error('Error:', error));
            }
            var form = document.getElementById("editForm");   
            document.getElementById("editID").addEventListener("input", function () {
                function enviarFormulari() {
                    editRow();
                }

                var interval = 10000; // envia cada 10 segons
                var enviaInterval = setInterval(enviarFormulari, interval);

                document.getElementById("editID").addEventListener("focus", function () {
                    clearInterval(enviaInterval);
                });

                document.getElementById("editID").addEventListener("blur", function () {
                    enviaInterval = setInterval(enviarFormulari, interval);
                });
            });
            function clean() {
                document.getElementById("editForm").reset();
            }

            function gestorBBDD(that) {
                if (that.value == "filas") {
                    document.getElementById("gestionFilas").style.display = "block";
                    document.getElementById("gestionTablas").style.display = "none";
                } else {
                    document.getElementById("gestionFilas").style.display = "none";
                    document.getElementById("gestionTablas").style.display = "block";
                    //gestionTablas
                }
            }

            function agregarCampo() {
                // Crear elementos
                var container = document.getElementById('createTable');
                var campo = document.createElement('div'); // Contenedor para cada conjunto de select e input
                var input = document.createElement('input');
                var botonEliminar = document.createElement('button');   

                // Configurar atributos del input y agregar al contenedor
                input.type = 'text';
                
                // Configurar el botón de eliminar
                botonEliminar.textContent = 'Eliminar Campo';
                botonEliminar.onclick = function() {
                    container.removeChild(campo); // Eliminar el conjunto select e input
                    actualizarConteo();
                };

                // Agregar elementos al contenedor
                campo.appendChild(input);
                campo.appendChild(botonEliminar);
                container.appendChild(campo);

                actualizarConteo();
                var campoId = 'campo_' + actualizarConteo();
                campo.id = campoId;
            }

            function actualizarConteo() {
                var formulario = document.getElementById('createTable');
                var conteoElemento = document.getElementById('conteo');
                // Contar solo los elementos input dentro del formulario
                var numeroCampos = formulario.querySelectorAll('input').length - 1;
                conteoElemento.textContent = 'Número de campos: ' + numeroCampos;
                return numeroCampos;
            }

            function obtenerValoresInputs(contenedor) {
                var valores = [];
                var divs = contenedor.querySelectorAll('div');

                for (var i = 1; i < divs.length; i++) {
                var input = divs[i].querySelector('input');
                if (input) {
                    valores.push(input.value);
                }
                }
                return valores;
            }
            
            function createTable() {
                var tableName = document.getElementById("createName").value
                var campos = obtenerValoresInputs(gestionTablas).length;
                var strCampos = '`ID` int not null auto_increment primary key,'
                var datos = obtenerValoresInputs(gestionTablas)
                for (let i=0;i<campos;i++) {
                    if (i != (campos-1)) {
                        strCampos += '`'+obtenerValoresInputs(gestionTablas)[i]+'` char(100) not null, '
                    } else {
                        strCampos += '`'+obtenerValoresInputs(gestionTablas)[i]+'` char(100) not null'
                    }
                }
                fetch('/submitTable', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({nameTable: tableName, strValues: strCampos}),
                    })
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('mensajeInformativo').innerText = data.message
                        document.getElementById("createTable").reset();
                    })
                .catch(error => console.error('Error:', error));
            }

            function eliminarTabla() {
                var nombreTabla = document.getElementById('tabla_borrar').value

                fetch('/deleteTabla', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({nameTable: nombreTabla}),
                    })
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('mensajeInformativo').innerText = data.message
                        document.getElementById("deleteTable").reset();
                    })
                .catch(error => console.error('Error:', error));
            }

            // EDITAR TAULA.
            function editTable() {
                var tableName = document.getElementById("editTableName").value;
                var strChanges = obtenerValoresInputs(gestionTablas).join(", ");
                fetch('/modTable', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ nameTable: tableName, strChanges: strChanges }),
                })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    document.getElementById("editTableForm").reset();
                }) .catch(error => console.error('Error:', error)); }
        </script>                
        
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Lora:wght@500&display=swap');
            body{
                padding: 0;
                margin: 0;
            }

            header {
                height: 200px;
                background-image: url(./imgs/database.jpg);
                background-repeat: no-repeat;
                background-attachment: fixed;
                background-size: cover;
                display: flex;
                align-items: center;
                justify-content: center;
            }       

            header h1{
                text-align: center;
                font-size: 30px;
                color: white;
            }

            .editar {
                display: none;
            }

            .container{
                margin: 50px;
                display: none;
            }

            h2{
                font-size: 24px;
                font-family: 'Lora', serif;
            }

            h3{
                font-size: 18px;
                font-family: 'Lora', serif;
                font-style: italic;
                font-weight: 200;
                color: grey;
            }

            #crearFilaDiv input[type="text"], .esborrarSection select, #modificarForm select, #nouValor{
                padding: 5px;
                margin-bottom: 5px;
                border: 1px solid rgb(23, 97, 110);
                border-radius: 50px;
            }

            #seguentButton, #esborrarButton, #modificarButton{
                transition-duration: 1s;
                cursor: pointer;
                padding: 5px;
                margin-top: 5px;
                background-color: rgb(23, 97, 110);
                border: 1px solid rgb(23, 97, 110);
                border-radius: 5px;
                color: white;
            }

            #seguentButton:hover, #esborrarButton:hover, #modificarButton:hover{
                transition-duration: 1s;
                cursor: pointer;
                background-color: rgb(176, 203, 207);
                border: 1px solid rgb(176, 203, 207);
                border-radius: 5px;
                color: black;
            }

            .modificarFilaDiv h3{
                margin-top: 50px;
            }

            #modificarForm select, .esborrarSection select{
                margin-top: 20px;
                margin-bottom: 20px;
            }

            #modificarButton, #nouValor{
                margin-top: 10px;
            }

            .esborrarFilaDiv h3{
                margin-top: 50px;
            }

            .esborrarBBDD{
                padding-bottom: 20px;
            }
        </style>

        </body>
</html>